{"version":3,"sources":["../src/index.js"],"names":["lmsr","utils","oracles","events","markets","windowLoaded","accept","reject","window","addEventListener","Error","loadHandler","event","removeEventListener","gasStatsData","require","gasLimit","gasDefaultMaxMultiplier","implementationInterfaceMap","StandardMarket","contractArtifacts","map","name","push","instanceModules","Gnosis","opts","ipfs","host","port","protocol","gnosis","initialized","promisifyAll","contracts","artifact","c","contract_name","prototype","gasStats","addProp","cs","maxGasCost","Math","max","fnStats","gasUsed","Infinity","implName","defaults","gas","min","TruffleContract","forEach","module","instanceProp","estimateGas","bind","setWeb3Provider","ethereum","defaultAccount","provider","web3","currentProvider","providers","HttpProvider","send","sendAsync","TypeError","setProvider","promisify","eth","getAccounts","accounts","length","setDefaultAccount","all","trySettingContractInstance","EtherToken","StandardMarketFactory","LMSRMarketMaker","OlympiaToken","instanceName","contract","deployed","message","includes","account","from"],"mappings":"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","file":"index.js","sourcesContent":["import _ from 'lodash'\nimport TruffleContract from 'truffle-contract'\nimport Web3 from 'web3'\nimport IPFS from 'ipfs-mini'\n\nimport * as lmsr from './lmsr'\nimport * as utils from './utils'\nimport * as oracles from './oracles'\nimport * as events from './events'\nimport * as markets from './markets'\n\nconst windowLoaded = new Promise((accept, reject) => {\n    if(typeof window === 'undefined')\n        return accept()\n\n    if(typeof window.addEventListener !== 'function')\n        return reject(new Error('expected to be able to register event listener'))\n\n    window.addEventListener('load', function loadHandler(event) {\n        window.removeEventListener('load', loadHandler, false)\n        return accept(event)\n    }, false)\n})\n\nconst gasStatsData = require('@gnosis.pm/gnosis-core-contracts/build/gas-stats.json')\nconst gasLimit = 4e6\nconst gasDefaultMaxMultiplier = 1.5\n\nconst implementationInterfaceMap = {\n    StandardMarket: ['Market'],\n}\n\nconst contractArtifacts = [\n    'Math',\n    'Event',\n    'CategoricalEvent',\n    'ScalarEvent',\n    'EventFactory',\n    'Token',\n    'HumanFriendlyToken',\n    'EtherToken',\n    'CentralizedOracle',\n    'CentralizedOracleFactory',\n    'UltimateOracle',\n    'UltimateOracleFactory',\n    'LMSRMarketMaker',\n    'Market',\n    'StandardMarket',\n    'StandardMarketFactory',\n].map((name) => require(`@gnosis.pm/gnosis-core-contracts/build/contracts/${name}.json`))\n\ncontractArtifacts.push(require('@gnosis.pm/olympia-token/build/contracts/OlympiaToken.json'))\n\nconst instanceModules = [oracles, events, markets]\n\n/**\n * Represents the gnosis.js API\n */\nclass Gnosis {\n    /**\n     * Factory function for asynchronously creating an instance of the API\n     *\n     * Note: this method is asynchronous and will return a Promise\n     *\n     * @param {(string|Provider)} [opts.ethereum] - An instance of a Web3 provider or a URL of a Web3 HTTP provider. If not specified, Web3 provider will be either the browser-injected Web3 (Mist/MetaMask) or an HTTP provider looking at http://localhost:8545\n     * @param {string} [opts.defaultAccount] - The account to use as the default `from` address for ethereum transactions conducted through the Web3 instance. If unspecified, will be the first account found on Web3. See {@link Gnosis#setWeb3Provider} `defaultAccount` parameter for more info.\n     * @param {Object} [opts.ipfs] - ipfs-mini configuration object\n     * @param {string} [opts.ipfs.host='ipfs.infura.io'] - IPFS node address\n     * @param {Number} [opts.ipfs.port=5001] - IPFS protocol port\n     * @param {string} [opts.ipfs.protocol='https'] - IPFS protocol name\n     * @returns {Gnosis} An instance of the gnosis.js API\n     */\n    static async create (opts) {\n        opts = _.defaultsDeep(opts || {}, {\n            ipfs: {\n                host: 'ipfs.infura.io',\n                port: 5001,\n                protocol: 'https'\n            }\n        })\n\n        let gnosis = new Gnosis(opts)\n        await gnosis.initialized(opts)\n        return gnosis\n    }\n\n    /**\n     * **Warning:** Do not use constructor directly. Some asynchronous initialization will not be handled. Instead, use {@link Gnosis.create}.\n     * @constructor\n     */\n    constructor (opts) {\n        // IPFS instantiation\n        this.ipfs = utils.promisifyAll(new IPFS(opts.ipfs))\n\n        /**\n         * A collection of Truffle contract abstractions for the following Gnosis contracts:\n         *\n         * - [Math](https://gnosis.github.io/gnosis-contracts/docs/Math)\n         * - [Event](https://gnosis.github.io/gnosis-contracts/docs/Event)\n         * - [CategoricalEvent](https://gnosis.github.io/gnosis-contracts/docs/CategoricalEvent)\n         * - [ScalarEvent](https://gnosis.github.io/gnosis-contracts/docs/ScalarEvent)\n         * - [EventFactory](https://gnosis.github.io/gnosis-contracts/docs/EventFactory)\n         * - [Token](https://gnosis.github.io/gnosis-contracts/docs/Token)\n         * - [HumanFriendlyToken](https://gnosis.github.io/gnosis-contracts/docs/HumanFriendlyToken)\n         * - [EtherToken](https://gnosis.github.io/gnosis-contracts/docs/EtherToken)\n         * - [CentralizedOracle](https://gnosis.github.io/gnosis-contracts/docs/CentralizedOracle)\n         * - [CentralizedOracleFactory](https://gnosis.github.io/gnosis-contracts/docs/CentralizedOracleFactory)\n         * - [UltimateOracle](https://gnosis.github.io/gnosis-contracts/docs/UltimateOracle)\n         * - [UltimateOracleFactory](https://gnosis.github.io/gnosis-contracts/docs/UltimateOracleFactory)\n         * - [LMSRMarketMaker](https://gnosis.github.io/gnosis-contracts/docs/LMSRMarketMaker)\n         * - [Market](https://gnosis.github.io/gnosis-contracts/docs/Market)\n         * - [StandardMarket](https://gnosis.github.io/gnosis-contracts/docs/StandardMarket)\n         * - [StandardMarketFactory](https://gnosis.github.io/gnosis-contracts/docs/StandardMarketFactory)\n         * - [OlympiaToken](https://github.com/gnosis/olympia-token)\n         *\n         * These are configured to use the web3 provider specified in {@link Gnosis.create} or subsequently modified with {@link Gnosis#setWeb3Provider}. The default gas costs for these abstractions are set to the maximum cost of their respective entries found in the `gas-stats.json` file built from the [core contracts](https://github.com/gnosis/gnosis-contracts#readme). Additionally, the default message sender (i.e. `from` address) is set via the optional `defaultAccount` param in {@link Gnosis#setWeb3Provider}.\n         *\n         * @member {Object} Gnosis#contracts\n         */\n        this.contracts = _.fromPairs(contractArtifacts.map((artifact) => {\n            const c = TruffleContract(artifact)\n            const name = c.contract_name\n\n            if(gasStatsData[name] != null) {\n                c.prototype.gasStats = gasStatsData[name]\n                c.addProp('gasStats', () => gasStatsData[name])\n            }\n\n            return [name, c]\n        }))\n\n        _.forEach(this.contracts, (c, name, cs) => {\n            const maxGasCost = Math.max(\n                ...Object.values(c.gasStats || {}).map(\n                    (fnStats) => fnStats.max != null ? fnStats.max.gasUsed : -Infinity),\n                ..._.flatMap(implementationInterfaceMap[name] || [],\n                    (implName) => Object.values(cs[implName].gasStats || {}).map(\n                        (fnStats) => fnStats.max != null ? fnStats.max.gasUsed : -Infinity))\n            )\n\n            if(maxGasCost > 0) {\n                c.defaults({ gas: Math.min(gasLimit, (gasDefaultMaxMultiplier * maxGasCost) | 0) })\n            }\n        })\n\n        this.TruffleContract = TruffleContract\n\n        instanceModules.forEach((module) => {\n            Object.keys(module).forEach((instanceProp) => {\n                if(\n                    this[instanceProp] != null &&\n                    typeof this[instanceProp].estimateGas === 'function'\n                ) {\n                    this[instanceProp].estimateGas = this[instanceProp].estimateGas.bind(this)\n                }\n            })\n        })\n    }\n\n    async initialized (opts) {\n        await this.setWeb3Provider(opts.ethereum, opts.defaultAccount)\n    }\n\n    /**\n     * Setter for the ethereum web3 provider.\n     *\n     * Note: this method is asynchronous and will return a Promise\n     *\n     * @param {(string|Provider)} [provider] - An instance of a Web3 provider or a URL of a Web3 HTTP provider. If not specified, Web3 provider will be either the browser-injected Web3 (Mist/MetaMask) or an HTTP provider looking at http://localhost:8545\n     * @param {(string)} [defaultAccount] - An address to be used as the default `from` account for conducting transactions using the associated Web3 instance. If not specified, will be inferred from Web3 using the first account obtained by `web3.eth.getAccounts`. If no such account exists, default account will not be set.\n     */\n    async setWeb3Provider (provider, defaultAccount) {\n        if (provider == null) {\n            // Prefer Web3 injected by the browser (Mist/MetaMask)\n            // Window must be loaded first so that there isn't a race condition for resolving injected Web3 instance\n            await windowLoaded\n\n            if (typeof web3 !== 'undefined') {\n                this.web3 = new Web3(web3.currentProvider)\n            } else {\n                this.web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'))\n            }\n        } else if (typeof provider === 'string') {\n            this.web3 = new Web3(new Web3.providers.HttpProvider(provider))\n        } else if (\n            typeof provider === 'object' &&\n            typeof provider.send === 'function' &&\n            typeof provider.sendAsync === 'function'\n        ) {\n            this.web3 = new Web3(provider)\n        } else {\n            throw new TypeError(`provider of type '${typeof provider}' not supported`)\n        }\n\n        _.forOwn(this.contracts, (c) => { c.setProvider(this.web3.currentProvider) })\n\n        if(defaultAccount == null) {\n            const accounts = await utils.promisify(this.web3.eth.getAccounts)()\n\n            if (accounts.length > 0) {\n                this.setDefaultAccount(accounts[0])\n            }\n        } else {\n            this.setDefaultAccount(defaultAccount)\n        }\n\n        await Promise.all([\n            /**\n             * If [EtherToken](https://gnosis.github.io/gnosis-contracts/docs/EtherToken/) is deployed to the current network, this will be set to an EtherToken contract abstraction pointing at the deployment address.\n             *\n             * @member {Contract} Gnosis#etherToken\n             */\n            this.trySettingContractInstance('etherToken', this.contracts.EtherToken),\n\n            /**\n             * If [StandardMarketFactory](https://gnosis.github.io/gnosis-contracts/docs/StandardMarketFactory/) is deployed to the current network, this will be set to an StandardMarketFactory contract abstraction pointing at the deployment address.\n             *\n             * @member {Contract} Gnosis#standardMarketFactory\n             */\n            this.trySettingContractInstance('standardMarketFactory', this.contracts.StandardMarketFactory),\n\n            /**\n             * If [LMSRMarketMaker](https://gnosis.github.io/gnosis-contracts/docs/LMSRMarketMaker/) is deployed to the current network, this will be set to an LMSRMarketMaker contract abstraction pointing at the deployment address.\n             *\n             * @member {Contract} Gnosis#lmsrMarketMaker\n             */\n            this.trySettingContractInstance('lmsrMarketMaker', this.contracts.LMSRMarketMaker),\n\n            /**\n             * If [OlympiaToken](https://github.com/gnosis/olympia-token) is deployed to the current network (this should only work for Rinkeby), this will be set to an OlympiaToken contract abstraction pointing at the deployment address.\n             *\n             * @member {Contract} Gnosis#olympiaToken\n             */\n            this.trySettingContractInstance('olympiaToken', this.contracts.OlympiaToken),\n        ])\n    }\n\n    async trySettingContractInstance(instanceName, contract) {\n        try {\n            this[instanceName] = await contract.deployed()\n        } catch(e) {\n            delete this[instanceName]\n            if(!e.message.includes('has not been deployed to detected network')) {\n                throw e\n            }\n        }\n    }\n\n\n    setDefaultAccount (account) {\n        /**\n         * The default account to be used as the `from` address for transactions done with this Gnosis instance. If there is no account, this will not be set.\n         *\n         * @member {string} Gnosis#defaultAccount\n         */\n        this.defaultAccount = account\n        _.forOwn(this.contracts, (c) => {\n            c.defaults({\n                from: account\n            })\n        })\n    }\n}\n\n_.assign(Gnosis.prototype, ...instanceModules)\n_.assign(Gnosis, lmsr, utils)\n\nexport default Gnosis\n"]}